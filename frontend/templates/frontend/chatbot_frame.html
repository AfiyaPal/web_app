<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>AfiyaPal Chat</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            margin:0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            overflow: hidden;
        }
        
        .chat-container { 
            max-width:100%; 
            margin:0; 
            display:flex; 
            flex-direction:column; 
            height:100vh; 
            background:white;
            overflow:hidden;
        }
        
        .chat-header { 
            padding:12px 16px; 
            background:linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%);
            display:flex; 
            justify-content:space-between; 
            align-items:center; 
            border:none;
            color:white;
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.2);
        }
        
        .chat-header strong {
            font-size:1rem;
            font-weight:600;
            letter-spacing:0.3px;
        }
        
        .chat-header a { 
            font-size:0.75rem;
            color:rgba(255,255,255,0.8);
            text-decoration:none;
            padding:4px 8px;
            border-radius:4px;
            transition: background 0.2s;
        }
        
        .chat-header a:hover {
            background:rgba(255,255,255,0.15);
        }
        
        #chat-messages { 
            flex:1; 
            overflow-y:auto; 
            padding:12px 16px; 
            background:#fafafa;
            display:flex;
            flex-direction:column;
            gap:8px;
        }
        
        #chat-messages::-webkit-scrollbar {
            width:6px;
        }
        
        #chat-messages::-webkit-scrollbar-track {
            background:transparent;
        }
        
        #chat-messages::-webkit-scrollbar-thumb {
            background:#cbd5e1;
            border-radius:3px;
        }
        
        #chat-messages::-webkit-scrollbar-thumb:hover {
            background:#94a3b8;
        }
        
        .message {
            display:flex;
            margin-bottom:4px;
            animation:slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity:0;
                transform:translateY(8px);
            }
            to {
                opacity:1;
                transform:translateY(0);
            }
        }
        
        .message.user {
            justify-content:flex-end;
        }
        
        .message.ai {
            justify-content:flex-start;
        }
        
        .message-bubble {
            max-width:75%;
            padding:10px 14px;
            border-radius:12px;
            word-wrap:break-word;
            line-height:1.4;
            font-size:0.9rem;
        }
        
        .message.user .message-bubble {
            background:linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%);
            color:white;
            border-bottom-right-radius:4px;
            box-shadow:0 2px 8px rgba(14, 165, 233, 0.15);
        }
        
        .message.ai .message-bubble {
            background:white;
            color:#1e293b;
            border:1px solid #e2e8f0;
            border-bottom-left-radius:4px;
            box-shadow:0 1px 3px rgba(0,0,0,0.05);
        }
        
        .typing-indicator {
            display:flex;
            align-items:center;
            gap:4px;
            padding:10px 14px;
            background:white;
            border:1px solid #e2e8f0;
            border-radius:12px;
            border-bottom-left-radius:4px;
            width:fit-content;
        }
        
        .typing-dot {
            width:8px;
            height:8px;
            border-radius:50%;
            background:#94a3b8;
            animation:typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay:0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay:0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% { opacity:0.3; transform:translateY(0); }
            30% { opacity:1; transform:translateY(-8px); }
        }
        
        #chat-form { 
            display:flex; 
            border-top:1px solid #e2e8f0; 
            padding:12px;
            gap:8px;
            background:white;
        }
        
        #chat-form input { 
            flex:1; 
            padding:10px 14px; 
            border:1px solid #cbd5e1;
            border-radius:8px;
            outline:none;
            font-size:0.9rem;
            transition:border 0.2s, box-shadow 0.2s;
        }
        
        #chat-form input:focus {
            border-color:#0ea5e9;
            box-shadow:0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        
        #chat-form button { 
            padding:10px 20px; 
            border:none; 
            background:linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%);
            color:#fff;
            cursor:pointer;
            border-radius:8px;
            font-weight:600;
            transition:transform 0.15s, box-shadow 0.2s;
            box-shadow:0 2px 8px rgba(14, 165, 233, 0.2);
        }
        
        #chat-form button:hover {
            transform:translateY(-1px);
            box-shadow:0 4px 12px rgba(14, 165, 233, 0.3);
        }
        
        #chat-form button:active {
            transform:translateY(0);
        }
        
        #chat-form button:disabled {
            opacity:0.7;
            cursor:not-allowed;
        }
        
        .empty-state {
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            height:100%;
            color:#64748b;
            text-align:center;
            padding:20px;
        }
        
        .empty-state svg {
            width:48px;
            height:48px;
            margin-bottom:12px;
            opacity:0.5;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <strong>AfiyaPal</strong>
            <a href="?clear=1">Clear</a>
        </div>
        <div id="chat-messages">
            {% if messages %}
                {% for msg in messages %}
                    <div class="message {{ msg.sender }}">
                        <div class="message-bubble">{{ msg.text }}</div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="2" y="2" width="20" height="16" rx="3" fill="none" stroke="currentColor" stroke-width="2"/>
                        <path d="M7 14l5-4 5 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M8 19l4-2 4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <p style="margin:0; font-size:0.9rem;">Get FirstAid and Mental Health Support</p>
                </div>
            {% endif %}
        </div>
        <form id="chat-form" method="post" action="{% url 'frontend:chatbot_frame' %}">
            {% csrf_token %}
            <input type="text" name="message" placeholder="Describe your symptoms..." required autocomplete="off" />
            <button type="submit" id="send-btn">Send</button>
        </form>
    </div>

    <script>
    const chatMessages = document.getElementById('chat-messages');
    const form = document.getElementById('chat-form');
    const sendBtn = document.getElementById('send-btn');
    const inputField = document.querySelector('#chat-form input[name="message"]');
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function addMessage(sender, text) {
        // Remove typing indicator before adding new message
        const typingIndicator = chatMessages.querySelector('.typing-indicator-wrapper');
        if (typingIndicator) {
            typingIndicator.remove();
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        
        // Use markdown-it to render Markdown
        const md = window.markdownit();
        const renderedHtml = md.render(text);
        
        messageDiv.innerHTML = `<div class="message-bubble">${renderedHtml}</div>`;
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
    }

    // Auto-scroll to bottom on page load
    scrollToBottom();

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const userMsg = inputField.value.trim();
        if (!userMsg) return;

        // Disable form
        sendBtn.disabled = true;
        sendBtn.textContent = 'Sending...';
        inputField.disabled = true;

        // Add user message to UI
        addMessage('user', userMsg);
        inputField.value = '';

        // Remove empty state if present
        const emptyState = chatMessages.querySelector('.empty-state');
        if (emptyState) emptyState.remove();

        // Show typing indicator
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message ai typing-indicator-wrapper'; // Add a wrapper class
        typingDiv.innerHTML = '<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
        chatMessages.appendChild(typingDiv);
        scrollToBottom();

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest' // To identify AJAX requests in Django
                },
                body: `message=${encodeURIComponent(userMsg)}`
            });

            if (!response.ok) {
                 const errorText = await response.text();
                 let errorMessage = `HTTP error! Status: ${response.status}`;
                 try {
                     const errorJson = JSON.parse(errorText);
                     errorMessage = errorJson.error || errorMessage;
                 } catch (e) {
                     // Not a JSON response, use the plain text.
                     errorMessage = errorText;
                 }
                 throw new Error(errorMessage);
            }
            
            const responseData = await response.json();

            // Replace typing indicator with AI response
            const typingIndicator = chatMessages.querySelector('.typing-indicator-wrapper');
            if (typingIndicator) {
                typingIndicator.remove();
            }
            addMessage('ai', responseData.text);


        } catch (error) {
            console.error('Fetch error:', error);
            const errorText = error.message || 'Sorry, something went wrong. Please try again.';
            addMessage('ai', errorText);
        } finally {
            // Re-enable form
            sendBtn.disabled = false;
            sendBtn.textContent = 'Send';
            inputField.disabled = false;
            
            // Make sure typing indicator is removed
            const typingIndicator = chatMessages.querySelector('.typing-indicator-wrapper');
            if (typingIndicator) {
                typingIndicator.remove();
            }

            inputField.focus();
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
</body>
</html>
